{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.27.1.19265",
      "templateHash": "9779290931170741189"
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "uniqueId": "[take(uniqueString(subscription().subscriptionId, resourceGroup().id), 7)]",
    "storageAccountName": "[format('stmediaservices{0}', variables('uniqueId'))]",
    "functionAppStorageAccountName": "[format('stmediaservicesfa{0}', variables('uniqueId'))]",
    "cosmosdbaccountName": "[format('cosmos-mediaservices-{0}', variables('uniqueId'))]",
    "cosmosdbsqldatabaseName": "[format('cossql-mediaservices-{0}', variables('uniqueId'))]",
    "cdnProfileName": "[format('cdn-mediaservices-{0}', variables('uniqueId'))]",
    "cdnEndpointName": "[format('cdne-mediaservices-{0}', variables('uniqueId'))]",
    "functionappName": "[format('func-mediaservices-{0}', variables('uniqueId'))]",
    "logAnalyticsWorkspaceName": "[format('log-mediaservices-{0}', variables('uniqueId'))]",
    "functionappAppServicePlanName": "[format('asp-mediaservices-{0}', variables('uniqueId'))]",
    "applicationInsightsName": "[format('appi-mediaservices-{0}', variables('uniqueId'))]",
    "deploymentScriptName": "[format('depfunczip-mediaservices-{0}', variables('uniqueId'))]",
    "fileShareName": "assets-share",
    "scriptShareName": "script-share",
    "queueName": "encoderjobs-queue",
    "blobContainerName": "assets-storage-container",
    "functionAppBlobContainerName": "code-storage-container",
    "sqlcontainerJobsName": "EncoderJobs",
    "sqlcontainerPresetsName": "EncoderPresets",
    "containerInstanceName": "[format('ci-mediaservices-{0}', variables('uniqueId'))]",
    "storageBlobReaderRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
    "contributorRoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storageAccount",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "17802126737746606755"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-04-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": {
                "owner": "tagValue"
              },
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "defaultToOAuthAuthentication": false,
                "allowCrossTenantReplication": false,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
              }
            }
          ],
          "outputs": {
            "blobEndpoint": {
              "type": "string",
              "value": "[replace(replace(reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-04-01').primaryEndpoints.blob, 'https://', ''), '/', '')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-04-01').keys[0].value]"
            },
            "storageAccountApiVersion": {
              "type": "string",
              "value": "2023-04-01"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionAppStorageAccount",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "storageAccountName": {
            "value": "[variables('functionAppStorageAccountName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "17802126737746606755"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-04-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": {
                "owner": "tagValue"
              },
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "defaultToOAuthAuthentication": false,
                "allowCrossTenantReplication": false,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
              }
            }
          ],
          "outputs": {
            "blobEndpoint": {
              "type": "string",
              "value": "[replace(replace(reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-04-01').primaryEndpoints.blob, 'https://', ''), '/', '')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-04-01').keys[0].value]"
            },
            "storageAccountApiVersion": {
              "type": "string",
              "value": "2023-04-01"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionAppBlobContainer",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('functionAppStorageAccountName')]"
          },
          "blobContainerName": {
            "value": "[variables('functionAppBlobContainerName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "2332504029245951871"
            }
          },
          "parameters": {
            "blobContainerName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('blobContainerName'))]",
              "properties": {
                "immutableStorageWithVersioning": {
                  "enabled": false
                },
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "queue",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('functionAppStorageAccountName')]"
          },
          "queueName": {
            "value": "[variables('queueName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "8876329847027071437"
            }
          },
          "parameters": {
            "queueName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('queueName'))]",
              "properties": {
                "metadata": {}
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploymentScript",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "deploymentScriptName": {
            "value": "[variables('deploymentScriptName')]"
          },
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "functionAppStorageAccountName": {
            "value": "[variables('functionAppStorageAccountName')]"
          },
          "fileShareName": {
            "value": "[variables('scriptShareName')]"
          },
          "storageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2022-09-01').outputs.storageAccountId.value]"
          },
          "functionAppStorageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount'), '2022-09-01').outputs.storageAccountId.value]"
          },
          "storageAccountApiVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount'), '2022-09-01').outputs.storageAccountApiVersion.value]"
          },
          "blobContainerName": {
            "value": "[variables('functionAppBlobContainerName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "9239032995479909429"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "deploymentScriptName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountId": {
              "type": "string"
            },
            "functionAppStorageAccountName": {
              "type": "string"
            },
            "functionAppStorageAccountId": {
              "type": "string"
            },
            "blobContainerName": {
              "type": "string"
            },
            "fileShareName": {
              "type": "string"
            },
            "storageAccountApiVersion": {
              "type": "string"
            },
            "currentTime": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            }
          },
          "variables": {
            "sasDefinition": {
              "signedServices": "b",
              "signedPermission": "rwdlacup",
              "signedExpiry": "[dateTimeAdd(parameters('currentTime'), 'PT1H')]",
              "signedResourceTypes": "sco",
              "signedProtocol": "https",
              "keyTosign": "key1"
            },
            "fileSasDefinition": {
              "signedServices": "f",
              "signedPermission": "rwdlacup",
              "signedExpiry": "[dateTimeAdd(parameters('currentTime'), 'PT1H')]",
              "signedResourceTypes": "sco",
              "signedProtocol": "https",
              "keyTosign": "key1"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[parameters('deploymentScriptName')]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "properties": {
                "azCliVersion": "2.52.0",
                "scriptContent": "[format('wget https://github.com/Tommaso23/Azure-Media-Services-environment/raw/master/code/functionApp.zip -O functionApp.zip  && az storage blob upload --account-name {0} --sas-token \"{1}\" --container-name {2} --name functionApp.zip --type block --file functionApp.zip --overwrite true && wget https://github.com/Tommaso23/Azure-Media-Services-environment/raw/master/code/ffmpegscript.sh -O ffmpegscript.sh && az storage file upload --account-name {3} --sas-token \"{4}\" --share-name {5} --source ffmpegscript.sh', parameters('functionAppStorageAccountName'), listAccountSas(parameters('functionAppStorageAccountId'), parameters('storageAccountApiVersion'), variables('sasDefinition')).accountSasToken, parameters('blobContainerName'), parameters('storageAccountName'), listAccountSas(parameters('storageAccountId'), parameters('storageAccountApiVersion'), variables('fileSasDefinition')).accountSasToken, parameters('fileShareName'))]",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D"
              }
            }
          ],
          "outputs": {
            "blobUrl": {
              "type": "string",
              "value": "[format('https://{0}.blob.core.windows.net/{1}/functionApp.zip', parameters('storageAccountName'), parameters('blobContainerName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionAppBlobContainer')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "fileShare",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "fileShareName": {
            "value": "[variables('fileShareName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "4316794869728481716"
            }
          },
          "parameters": {
            "fileShareName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('fileShareName'))]",
              "properties": {
                "accessTier": "TransactionOptimized",
                "shareQuota": 102400,
                "enabledProtocols": "SMB"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "ScriptFileShare",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "fileShareName": {
            "value": "[variables('scriptShareName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "4316794869728481716"
            }
          },
          "parameters": {
            "fileShareName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('fileShareName'))]",
              "properties": {
                "accessTier": "TransactionOptimized",
                "shareQuota": 102400,
                "enabledProtocols": "SMB"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "blobContainer",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "blobContainerName": {
            "value": "[variables('blobContainerName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "2332504029245951871"
            }
          },
          "parameters": {
            "blobContainerName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/default/{1}', parameters('storageAccountName'), parameters('blobContainerName'))]",
              "properties": {
                "immutableStorageWithVersioning": {
                  "enabled": false
                },
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionApp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "functionAppName": {
            "value": "[variables('functionappName')]"
          },
          "serverFarmId": {
            "value": "[variables('functionappAppServicePlanName')]"
          },
          "appSettings": {
            "value": [
              {
                "name": "AzureWebJobsStorage",
                "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1}', variables('functionAppStorageAccountName'), reference(resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount'), '2022-09-01').outputs.storageAccountKey.value)]"
              },
              {
                "name": "COSMOS_DB_AUTH_KEY",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount'), '2022-09-01').outputs.cosmosdbauthentificationKey.value]"
              },
              {
                "name": "COSMOS_DB_DATABASE",
                "value": "[variables('cosmosdbsqldatabaseName')]"
              },
              {
                "name": "COSMOS_DB_ENCODERJOBS_CONTAINER",
                "value": "[variables('sqlcontainerJobsName')]"
              },
              {
                "name": "COSMOS_DB_PRESETS_CONTAINER",
                "value": "[variables('sqlcontainerPresetsName')]"
              },
              {
                "name": "COSMOS_DB_ENDPOINT",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount'), '2022-09-01').outputs.cosmosdbendpoint.value]"
              },
              {
                "name": "FUNCTIONS_EXTENSION_VERSION",
                "value": "~4"
              },
              {
                "name": "ENCODER_ASSETS_STORAGE_CONTAINER_NAME",
                "value": "[variables('blobContainerName')]"
              },
              {
                "name": "ENCODER_ASSETS_STORAGE_FILESHARE_NAME",
                "value": "[variables('fileShareName')]"
              },
              {
                "name": "FA_STORAGE_ACCOUNT_NAME",
                "value": "[variables('functionappName')]"
              },
              {
                "name": "FA_STORAGE_ENCODERJOBS_QUEUE_NAME",
                "value": "[variables('queueName')]"
              },
              {
                "name": "FUNCTIONS_WORKER_RUNTIME",
                "value": "dotnet-isolated"
              },
              {
                "name": "RESOURCE_GROUP_NAME",
                "value": "[resourceGroup().name]"
              },
              {
                "name": "STORAGE_ACCOUNT_KEY",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2022-09-01').outputs.storageAccountKey.value]"
              },
              {
                "name": "SUBSCRIPTION_ID",
                "value": "[subscription().subscriptionId]"
              },
              {
                "name": "TENANT_ID",
                "value": "[tenant().tenantId]"
              },
              {
                "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                "value": "[format('DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName={0};AccountKey={1}', variables('functionAppStorageAccountName'), reference(resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount'), '2022-09-01').outputs.storageAccountKey.value)]"
              },
              {
                "name": "WEBSITE_CONTENTSHARE",
                "value": "[toLower(variables('functionappName'))]"
              },
              {
                "name": "WEBSITE_ENCODERASSETSSTORAGECONNECTIONSTRING",
                "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', variables('storageAccountName'), reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2022-09-01').outputs.storageAccountKey.value)]"
              },
              {
                "name": "WEBSITE_MOUNT_ENABLED",
                "value": "1"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[format('InstrumentationKey={0}', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2022-09-01').outputs.instrumentationKey.value)]"
              },
              {
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2022-09-01').outputs.instrumentationKey.value]"
              },
              {
                "name": "WEBSITE_RUN_FROM_PACKAGE",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploymentScript'), '2022-09-01').outputs.blobUrl.value]"
              },
              {
                "name": "CONTAINER_INSTANCE_NAME",
                "value": "[variables('containerInstanceName')]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "7802251748083443463"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "serverFarmId": {
              "type": "string"
            },
            "appSettings": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "enabled": true,
                "hostNameSslStates": [
                  {
                    "name": "[format('{0}.azurewebsites.net', parameters('functionAppName'))]",
                    "sslState": "Disabled",
                    "hostType": "Standard"
                  },
                  {
                    "name": "[format('{0}.scm.azurewebsites.net', parameters('functionAppName'))]",
                    "sslState": "Disabled",
                    "hostType": "Repository"
                  }
                ],
                "serverFarmId": "[parameters('serverFarmId')]",
                "reserved": true,
                "isXenon": false,
                "hyperV": false,
                "vnetRouteAllEnabled": false,
                "vnetImagePullEnabled": false,
                "vnetContentShareEnabled": false,
                "siteConfig": {
                  "appSettings": "[parameters('appSettings')]",
                  "numberOfWorkers": 1,
                  "linuxFxVersion": "DOTNET-ISOLATED|8.0",
                  "acrUseManagedIdentityCreds": false,
                  "alwaysOn": false,
                  "http20Enabled": true,
                  "functionAppScaleLimit": 200,
                  "minimumElasticInstanceCount": 0
                },
                "scmSiteAlsoStopped": false,
                "clientAffinityEnabled": false,
                "clientCertEnabled": false,
                "clientCertMode": "Required",
                "hostNamesDisabled": false,
                "customDomainVerificationId": "517B90CD51655432EB5DD9D88E4493ABCFD99BDA4241179C0DA8BC449D4EC896",
                "containerSize": 0,
                "dailyMemoryTimeQuota": 0,
                "httpsOnly": false,
                "redundancyMode": "None",
                "storageAccountRequired": false,
                "keyVaultReferenceIdentity": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-12-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsights')]",
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploymentScript')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionAppStorageAccount')]",
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionStorageRoleAssignment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "roleDefinitionId": {
            "value": "[variables('storageBlobReaderRoleDefinitionId')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2022-09-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "15062519771194080889"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            }
          },
          "variables": {
            "roleAssignmentName": "[guid(parameters('roleDefinitionId'), parameters('principalId'), resourceGroup().id)]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploymentScript')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionApp')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionContainerRoleAssignment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "roleDefinitionId": {
            "value": "[variables('contributorRoleDefinitionId')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2022-09-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "15062519771194080889"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            }
          },
          "variables": {
            "roleAssignmentName": "[guid(parameters('roleDefinitionId'), parameters('principalId'), resourceGroup().id)]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'functionApp')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appServicePlan",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "functionappAppServicePlanName": {
            "value": "[variables('functionappAppServicePlanName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "10337234883029548884"
            }
          },
          "parameters": {
            "functionappAppServicePlanName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('functionappAppServicePlanName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic",
                "size": "Y1",
                "family": "Y",
                "capacity": 0
              },
              "kind": "functionapp",
              "properties": {
                "perSiteScaling": false,
                "elasticScaleEnabled": false,
                "maximumElasticWorkerCount": 1,
                "isSpot": false,
                "reserved": true,
                "isXenon": false,
                "hyperV": false,
                "targetWorkerCount": 0,
                "targetWorkerSizeId": 0,
                "zoneRedundant": false
              }
            }
          ],
          "outputs": {
            "serverFarmId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('functionappAppServicePlanName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosdbaccount",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "cosmosDBAccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "7522017959579740495"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "cosmosDBAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-11-15",
              "name": "[parameters('cosmosDBAccountName')]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "identity": {
                "type": "None"
              },
              "properties": {
                "publicNetworkAccess": "Enabled",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "disableKeyBasedMetadataWriteAccess": false,
                "enableFreeTier": false,
                "enableAnalyticalStorage": false,
                "analyticalStorageConfiguration": {
                  "schemaType": "WellDefined"
                },
                "databaseAccountOfferType": "Standard",
                "defaultIdentity": "FirstPartyIdentity",
                "networkAclBypass": "None",
                "disableLocalAuth": false,
                "enablePartitionMerge": false,
                "enableBurstCapacity": false,
                "minimalTlsVersion": "Tls12",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session",
                  "maxIntervalInSeconds": 5,
                  "maxStalenessPrefix": 100
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "cors": [],
                "capabilities": [],
                "ipRules": [],
                "backupPolicy": {
                  "type": "Periodic",
                  "periodicModeProperties": {
                    "backupIntervalInMinutes": 240,
                    "backupRetentionIntervalInHours": 8,
                    "backupStorageRedundancy": "Geo"
                  }
                }
              }
            }
          ],
          "outputs": {
            "cosmosdbauthentificationKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), '2023-11-15').primaryMasterKey]"
            },
            "cosmosdbendpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), '2023-11-15').documentEndpoint]"
            },
            "cosmosdbaccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosDBSQLDatabase",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosdbaccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          },
          "cosmosdbsqlDatabaseName": {
            "value": "[variables('cosmosdbsqldatabaseName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "1499120528911029759"
            }
          },
          "parameters": {
            "cosmosdbaccountName": {
              "type": "string"
            },
            "cosmosdbsqlDatabaseName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}', parameters('cosmosdbaccountName'), parameters('cosmosdbsqlDatabaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosdbsqlDatabaseName')]"
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlcontainerJobs",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosdbAccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          },
          "sqldbName": {
            "value": "[variables('cosmosdbsqldatabaseName')]"
          },
          "sqlcontainerName": {
            "value": "[variables('sqlcontainerJobsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "17153670018621593577"
            }
          },
          "parameters": {
            "sqlcontainerName": {
              "type": "string"
            },
            "sqldbName": {
              "type": "string"
            },
            "cosmosdbAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosdbAccountName'), parameters('sqldbName'), parameters('sqlcontainerName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('sqlcontainerName')]",
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  },
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "uniqueKeyPolicy": {
                    "uniqueKeys": []
                  },
                  "conflictResolutionPolicy": {
                    "mode": "LastWriterWins",
                    "conflictResolutionPath": "/_ts"
                  },
                  "computedProperties": []
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDBSQLDatabase')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlcontainerPresets",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosdbAccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          },
          "sqldbName": {
            "value": "[variables('cosmosdbsqldatabaseName')]"
          },
          "sqlcontainerName": {
            "value": "[variables('sqlcontainerPresetsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "17153670018621593577"
            }
          },
          "parameters": {
            "sqlcontainerName": {
              "type": "string"
            },
            "sqldbName": {
              "type": "string"
            },
            "cosmosdbAccountName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosdbAccountName'), parameters('sqldbName'), parameters('sqlcontainerName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('sqlcontainerName')]",
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  },
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "uniqueKeyPolicy": {
                    "uniqueKeys": []
                  },
                  "conflictResolutionPolicy": {
                    "mode": "LastWriterWins",
                    "conflictResolutionPath": "/_ts"
                  },
                  "computedProperties": []
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDBSQLDatabase')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cdn",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cdnProfileName": {
            "value": "[variables('cdnProfileName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "8459306062936774387"
            }
          },
          "parameters": {
            "cdnProfileName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cdn/profiles",
              "apiVersion": "2023-05-01",
              "name": "[parameters('cdnProfileName')]",
              "location": "Global",
              "sku": {
                "name": "Standard_Microsoft"
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cdnEndpoint",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cdnProfileName": {
            "value": "[variables('cdnProfileName')]"
          },
          "cdnEndpointName": {
            "value": "[variables('cdnEndpointName')]"
          },
          "originHostName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storageAccount'), '2022-09-01').outputs.blobEndpoint.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "13327346137530229245"
            }
          },
          "parameters": {
            "cdnEndpointName": {
              "type": "string"
            },
            "cdnProfileName": {
              "type": "string"
            },
            "originHostName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cdn/profiles/endpoints",
              "apiVersion": "2024-02-01",
              "name": "[format('{0}/{1}', parameters('cdnProfileName'), parameters('cdnEndpointName'))]",
              "location": "global",
              "properties": {
                "originHostHeader": "[parameters('originHostName')]",
                "contentTypesToCompress": [
                  "application/eot",
                  "application/font",
                  "application/font-sfnt",
                  "application/javascript",
                  "application/json",
                  "application/opentype",
                  "application/otf",
                  "application/pkcs7-mime",
                  "application/truetype",
                  "application/ttf",
                  "application/vnd.ms-fontobject",
                  "application/xhtml+xml",
                  "application/xml",
                  "application/xml+rss",
                  "application/x-font-opentype",
                  "application/x-font-truetype",
                  "application/x-font-ttf",
                  "application/x-httpd-cgi",
                  "application/x-javascript",
                  "application/x-mpegurl",
                  "application/x-opentype",
                  "application/x-otf",
                  "application/x-perl",
                  "application/x-ttf",
                  "font/eot",
                  "font/ttf",
                  "font/otf",
                  "font/opentype",
                  "image/svg+xml",
                  "text/css",
                  "text/csv",
                  "text/html",
                  "text/javascript",
                  "text/js",
                  "text/plain",
                  "text/richtext",
                  "text/tab-separated-values",
                  "text/xml",
                  "text/x-script",
                  "text/x-component",
                  "text/x-java-source"
                ],
                "isCompressionEnabled": true,
                "isHttpAllowed": true,
                "isHttpsAllowed": true,
                "queryStringCachingBehavior": "IgnoreQueryString",
                "origins": [
                  {
                    "name": "default-origin-fa96716a",
                    "properties": {
                      "hostName": "[parameters('originHostName')]"
                    }
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'storageAccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlRoleDefinition",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosdbAccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          },
          "cosmosdbAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount'), '2022-09-01').outputs.cosmosdbaccountId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "17209892214576030165"
            }
          },
          "parameters": {
            "actions": {
              "type": "array",
              "defaultValue": [
                "Microsoft.DocumentDB/databaseAccounts/readMetadata",
                "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*"
              ]
            },
            "roleName": {
              "type": "string",
              "defaultValue": "CosmosDBReadWriteRole"
            },
            "cosmosdbAccountId": {
              "type": "string"
            },
            "cosmosdbAccountName": {
              "type": "string"
            }
          },
          "variables": {
            "roleDefName": "[guid(parameters('roleName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}', parameters('cosmosdbAccountName'), variables('roleDefName'))]",
              "properties": {
                "roleName": "[parameters('roleName')]",
                "type": "CustomRole",
                "assignableScopes": [
                  "[parameters('cosmosdbAccountId')]"
                ],
                "permissions": [
                  {
                    "dataActions": "[parameters('actions')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "roleDefinitionId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', split(format('{0}/{1}', parameters('cosmosdbAccountName'), variables('roleDefName')), '/')[0], split(format('{0}/{1}', parameters('cosmosdbAccountName'), variables('roleDefName')), '/')[1])]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlroleAssignment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDBAccountName": {
            "value": "[variables('cosmosdbaccountName')]"
          },
          "cosmosDBAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount'), '2022-09-01').outputs.cosmosdbaccountId.value]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionApp'), '2022-09-01').outputs.principalId.value]"
          },
          "roleDefinitionId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'sqlRoleDefinition'), '2022-09-01').outputs.roleDefinitionId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "10516570718955914234"
            }
          },
          "parameters": {
            "roleDefinitionId": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "cosmosDBAccountName": {
              "type": "string"
            },
            "cosmosDBAccountId": {
              "type": "string"
            }
          },
          "variables": {
            "roleAssignmentId": "[guid(parameters('roleDefinitionId'), parameters('principalId'), parameters('cosmosDBAccountId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}', parameters('cosmosDBAccountName'), variables('roleAssignmentId'))]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                "principalId": "[parameters('principalId')]",
                "scope": "[parameters('cosmosDBAccountId')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosdbaccount')]",
        "[resourceId('Microsoft.Resources/deployments', 'functionApp')]",
        "[resourceId('Microsoft.Resources/deployments', 'sqlRoleDefinition')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "logAnalytics",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "4366062570700593982"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "pergb2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "logAnlayticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "applicationInsights",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "applicationInsightsName": {
            "value": "[variables('applicationInsightsName')]"
          },
          "workspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics'), '2022-09-01').outputs.logAnlayticsWorkspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.27.1.19265",
              "templateHash": "932201223321714689"
            }
          },
          "parameters": {
            "applicationInsightsName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "workspaceId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('workspaceId')]"
              }
            }
          ],
          "outputs": {
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics')]"
      ]
    }
  ]
}